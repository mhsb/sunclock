<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunset Clock</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 20px;
            padding-bottom: 100px;
            transition: background 2s ease;
        }

        body[dir="rtl"] {
            font-family: 'Vazirmatn', 'Tahoma', 'Arial', sans-serif;
        }

        .language-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .language-toggle-icon {
            font-size: 1.1em;
        }

        .language-toggle-text {
            font-weight: 600;
        }

        .language-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 60px 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            max-width: 700px;
            width: 100%;
            text-align: center;
        }

        h1 {
            margin-bottom: 40px;
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .clock-display {
            font-size: 7em;
            font-weight: bold;
            margin: 40px 0;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.05em;
            line-height: 1.2;
        }

        .clock-label {
            font-size: 1.5em;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        /* Location Bar */
        .location-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 999;
            transition: transform 0.3s ease;
        }

        .location-bar-content {
            flex: 1;
            text-align: left;
        }

        .location-bar-content[dir="rtl"] {
            text-align: right;
        }

        .location-text {
            font-size: 1em;
            opacity: 0.9;
        }

        .location-toggle-btn {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            margin-left: 15px;
            white-space: nowrap;
            width: auto;
        }

        .location-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        body[dir="rtl"] .location-toggle-btn {
            margin-left: 0;
            margin-right: 15px;
        }

        /* Location Panel */
        .location-panel {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            padding: 30px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1001;
            transition: bottom 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .location-panel.show {
            bottom: 0;
        }

        .location-panel-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .location-form {
            padding: 20px 0;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        body[dir="rtl"] .form-group {
            text-align: right;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95em;
            opacity: 0.9;
        }

        .dropdown-container {
            position: relative;
            width: 100%;
        }

        .dropdown-input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1em;
            cursor: pointer;
        }

        .dropdown-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.15);
        }

        .dropdown-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-top: 5px;
            z-index: 1002;
            display: none;
        }

        .dropdown-list.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px;
            cursor: pointer;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .loading-cities {
            padding: 12px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9em;
        }

        button {
            width: 100%;
            padding: 14px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .location-toggle-btn,
        .language-toggle {
            width: auto;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .error {
            color: #ff6b6b;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .status {
            margin-top: 10px;
            font-size: 0.85em;
            opacity: 0.7;
        }

        .loading {
            opacity: 0.6;
        }

        @media (max-width: 768px) {
            .clock-display {
                font-size: 5em;
            }

            h1 {
                font-size: 2em;
            }

            .container {
                padding: 40px 20px;
            }
        }
    </style>
</head>
<body>
    <button class="language-toggle" id="languageToggle" onclick="toggleLanguage()">
        <span class="language-toggle-icon">üåê</span>
        <span class="language-toggle-text" id="languageToggleText">en</span>
    </button>
    
    <div class="container">
        <h1 id="title">üåÖ Sunset Clock</h1>
        <div class="clock-label" id="clockLabel">Time since sunset</div>
        <div class="clock-display" id="clock">00:00:00</div>
    </div>

    <div class="location-bar">
        <div class="location-bar-content" id="locationBarContent">
            <div class="location-text" id="locationText">Loading location...</div>
            <div class="status" id="status"></div>
        </div>
        <button class="location-toggle-btn" id="locationToggleBtn" onclick="toggleLocationPanel()">‚öôÔ∏è</button>
    </div>

    <div class="location-panel" id="locationPanel">
        <div class="location-panel-content">
            <div class="location-form">
                <div class="form-group">
                    <label for="country" id="countryLabel">Country:</label>
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" id="country" placeholder="Search country..." autocomplete="off">
                        <div class="dropdown-list" id="countryList"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="city" id="cityLabel">City:</label>
                    <div class="dropdown-container">
                        <input type="text" class="dropdown-input" id="city" placeholder="Select country first..." autocomplete="off" disabled>
                        <div class="dropdown-list" id="cityList"></div>
                    </div>
                </div>
                <button onclick="saveLocation()" id="saveBtn">Save Location</button>
                <div class="error" id="error"></div>
            </div>
        </div>
    </div>

    <script>
        // Translations
        const translations = {
            en: {
                title: 'üåÖ Sunset Clock',
                clockLabel: 'Time since sunset',
                countryLabel: 'Country:',
                cityLabel: 'City:',
                saveBtn: 'Save Location',
                locationText: 'Loading location...',
                pleaseEnterLocation: 'Please enter your location',
                searchCountry: 'Search country...',
                selectCountryFirst: 'Select country first...',
                searchCity: 'Search city...',
                loadingCities: 'Loading cities...',
                noCountriesFound: 'No countries found',
                noCitiesFound: 'No cities found',
                pleaseSelectBoth: 'Please select both country and city',
                pleaseSelectValidCountry: 'Please select a valid country from the list',
                locationNotSet: 'Location not set',
                fetchingSunset: 'Fetching sunset time...',
                usingCached: 'Using cached sunset time',
                sunsetUpdated: 'Sunset time updated',
                errorFetching: 'Error fetching sunset time. Using cached data if available.',
                usingCachedOutdated: 'Using cached sunset time (may be outdated)',
                unableToLoad: 'Unable to load sunset time',
                offline: 'Offline - using cached sunset time',
                settings: '‚öôÔ∏è'
            },
            fa: {
                title: 'üåÖ ÿ≥ÿßÿπÿ™ ÿ∫ÿ±Ÿàÿ®',
                clockLabel: 'ÿ≤ŸÖÿßŸÜ ÿßÿ≤ ÿ∫ÿ±Ÿàÿ®',
                countryLabel: '⁄©ÿ¥Ÿàÿ±:',
                cityLabel: 'ÿ¥Ÿáÿ±:',
                saveBtn: 'ÿ∞ÿÆ€åÿ±Ÿá ŸÖŸàŸÇÿπ€åÿ™',
                locationText: 'ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖŸàŸÇÿπ€åÿ™...',
                pleaseEnterLocation: 'ŸÑÿ∑ŸÅÿßŸã ŸÖŸàŸÇÿπ€åÿ™ ÿÆŸàÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ',
                searchCountry: 'ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ⁄©ÿ¥Ÿàÿ±...',
                selectCountryFirst: 'ÿßÿ®ÿ™ÿØÿß ⁄©ÿ¥Ÿàÿ± ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ...',
                searchCity: 'ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å ÿ¥Ÿáÿ±...',
                loadingCities: 'ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ¥Ÿáÿ±Ÿáÿß...',
                noCountriesFound: '⁄©ÿ¥Ÿàÿ±€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ',
                noCitiesFound: 'ÿ¥Ÿáÿ±€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ',
                pleaseSelectBoth: 'ŸÑÿ∑ŸÅÿßŸã ⁄©ÿ¥Ÿàÿ± Ÿà ÿ¥Ÿáÿ± ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ',
                pleaseSelectValidCountry: 'ŸÑÿ∑ŸÅÿßŸã €å⁄© ⁄©ÿ¥Ÿàÿ± ŸÖÿπÿ™ÿ®ÿ± ÿßÿ≤ ŸÑ€åÿ≥ÿ™ ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ',
                locationNotSet: 'ŸÖŸàŸÇÿπ€åÿ™ ÿ™ŸÜÿ∏€åŸÖ ŸÜÿ¥ÿØŸá',
                fetchingSunset: 'ÿØÿ± ÿ≠ÿßŸÑ ÿØÿ±€åÿßŸÅÿ™ ÿ≤ŸÖÿßŸÜ ÿ∫ÿ±Ÿàÿ®...',
                usingCached: 'ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ ÿ≤ŸÖÿßŸÜ ÿ∫ÿ±Ÿàÿ® ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØŸá',
                sunsetUpdated: 'ÿ≤ŸÖÿßŸÜ ÿ∫ÿ±Ÿàÿ® ÿ®Ÿá‚Äåÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ',
                errorFetching: 'ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ≤ŸÖÿßŸÜ ÿ∫ÿ±Ÿàÿ®. ÿØÿ± ÿµŸàÿ±ÿ™ Ÿàÿ¨ŸàÿØÿå ÿßÿ≤ ÿØÿßÿØŸá‚ÄåŸáÿß€å ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØŸá ÿßÿ≥ÿ™ŸÅÿßÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ.',
                usingCachedOutdated: 'ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ ÿ≤ŸÖÿßŸÜ ÿ∫ÿ±Ÿàÿ® ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØŸá (ŸÖŸÖ⁄©ŸÜ ÿßÿ≥ÿ™ ŸÇÿØ€åŸÖ€å ÿ®ÿßÿ¥ÿØ)',
                unableToLoad: 'ÿßŸÖ⁄©ÿßŸÜ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿ≤ŸÖÿßŸÜ ÿ∫ÿ±Ÿàÿ® Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ',
                offline: 'ÿ¢ŸÅŸÑÿß€åŸÜ - ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ ÿ≤ŸÖÿßŸÜ ÿ∫ÿ±Ÿàÿ® ÿ∞ÿÆ€åÿ±Ÿá ÿ¥ÿØŸá',
                settings: '‚öôÔ∏è'
            }
        };

        let currentLang = localStorage.getItem('sunsetClockLanguage') || 'en';
        let sunsetTime = null;
        let locationData = null;
        let clockInterval = null;
        let gradientInterval = null;
        let countriesList = [];
        let citiesList = [];
        let selectedCountry = null;
        let filteredCountries = [];
        let filteredCities = [];

        // Default values
        const DEFAULT_COUNTRY = 'Iran';
        const DEFAULT_CITY = 'Qom';

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            setLanguage(currentLang);
            initializeCountries();
            setupEventListeners();
            loadSavedLocation();
            updateGradient();
            setInterval(updateGradient, 60000); // Update gradient every minute
        });

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('sunsetClockLanguage', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';
            
            const t = translations[lang];
            document.getElementById('title').textContent = t.title;
            document.getElementById('clockLabel').textContent = t.clockLabel;
            document.getElementById('countryLabel').textContent = t.countryLabel;
            document.getElementById('cityLabel').textContent = t.cityLabel;
            document.getElementById('saveBtn').textContent = t.saveBtn;
            document.getElementById('country').placeholder = t.searchCountry;
            document.getElementById('city').placeholder = selectedCountry ? t.searchCity : t.selectCountryFirst;
            document.getElementById('languageToggleText').textContent = lang === 'en' ? 'ŸÅÿß' : 'en';
            
            updateLocationInfo();
        }

        function toggleLanguage() {
            const newLang = currentLang === 'en' ? 'fa' : 'en';
            setLanguage(newLang);
        }

        function toggleLocationPanel() {
            const panel = document.getElementById('locationPanel');
            panel.classList.toggle('show');
        }

        function updateGradient() {
            if (!sunsetTime) {
                // Default gradient
                document.body.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                return;
            }

            const now = new Date();
            const todaySunset = new Date(sunsetTime);
            todaySunset.setHours(todaySunset.getHours(), todaySunset.getMinutes(), todaySunset.getSeconds(), 0);
            
            const yesterdaySunset = new Date(todaySunset);
            yesterdaySunset.setDate(yesterdaySunset.getDate() - 1);
            
            let referenceSunset = todaySunset;
            if (now < todaySunset) {
                referenceSunset = yesterdaySunset;
            }
            
            const hoursSinceSunset = (now - referenceSunset) / (1000 * 60 * 60);
            
            // Gradient colors based on time of day (0-24 hours since sunset)
            let color1, color2;
            
            if (hoursSinceSunset < 2) {
                // Early night - deep purple/blue
                color1 = '#1a1a2e';
                color2 = '#16213e';
            } else if (hoursSinceSunset < 6) {
                // Midnight - dark blue
                color1 = '#0f0c29';
                color2 = '#302b63';
            } else if (hoursSinceSunset < 10) {
                // Late night - deep blue
                color1 = '#1e3c72';
                color2 = '#2a5298';
            } else if (hoursSinceSunset < 14) {
                // Early morning - blue to purple
                color1 = '#667eea';
                color2 = '#764ba2';
            } else if (hoursSinceSunset < 18) {
                // Morning - purple to pink
                color1 = '#f093fb';
                color2 = '#f5576c';
            } else if (hoursSinceSunset < 22) {
                // Afternoon - orange to red
                color1 = '#fa709a';
                color2 = '#fee140';
            } else {
                // Evening - red to purple (approaching sunset)
                color1 = '#f5576c';
                color2 = '#764ba2';
            }
            
            document.body.style.background = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
        }

        function setupEventListeners() {
            const countryInput = document.getElementById('country');
            const cityInput = document.getElementById('city');

            countryInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                filteredCountries = countriesList.filter(country => 
                    country.toLowerCase().includes(searchTerm)
                );
                renderCountryDropdown();
                document.getElementById('countryList').classList.add('show');
            });

            countryInput.addEventListener('focus', () => {
                if (countryInput.value === '') {
                    filteredCountries = [...countriesList];
                    renderCountryDropdown();
                }
                document.getElementById('countryList').classList.add('show');
            });

            cityInput.addEventListener('input', (e) => {
                if (!selectedCountry) return;
                const searchTerm = e.target.value.toLowerCase();
                filteredCities = citiesList.filter(city => 
                    city.name.toLowerCase().includes(searchTerm)
                );
                renderCityDropdown();
                document.getElementById('cityList').classList.add('show');
            });

            cityInput.addEventListener('focus', () => {
                if (!selectedCountry) return;
                if (cityInput.value === '') {
                    filteredCities = [...citiesList];
                    renderCityDropdown();
                }
                document.getElementById('cityList').classList.add('show');
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown-container')) {
                    document.getElementById('countryList').classList.remove('show');
                    document.getElementById('cityList').classList.remove('show');
                }
            });

            // Close location panel when clicking outside
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('locationPanel');
                const toggleBtn = document.getElementById('locationToggleBtn');
                if (panel.classList.contains('show') && 
                    !panel.contains(e.target) && 
                    !toggleBtn.contains(e.target)) {
                    panel.classList.remove('show');
                }
            });
        }

        async function initializeCountries() {
            countriesList = [
                'Afghanistan', 'Albania', 'Algeria', 'Argentina', 'Australia', 'Austria',
                'Bangladesh', 'Belgium', 'Brazil', 'Bulgaria', 'Canada', 'Chile', 'China',
                'Colombia', 'Croatia', 'Czech Republic', 'Denmark', 'Egypt', 'Finland',
                'France', 'Germany', 'Greece', 'Hungary', 'India', 'Indonesia', 'Iran',
                'Iraq', 'Ireland', 'Italy', 'Japan', 'Jordan', 'Kenya',
                'Kuwait', 'Lebanon', 'Malaysia', 'Mexico', 'Morocco', 'Netherlands',
                'New Zealand', 'Nigeria', 'Norway', 'Pakistan', 'Peru', 'Philippines',
                'Poland', 'Portugal', 'Qatar', 'Romania', 'Russia', 'Saudi Arabia',
                'Singapore', 'South Africa', 'South Korea', 'Spain', 'Sweden', 'Switzerland',
                'Syria', 'Thailand', 'Turkey', 'Ukraine', 'United Arab Emirates',
                'United Kingdom', 'United States', 'Venezuela', 'Vietnam', 'Yemen'
            ].sort();

            filteredCountries = [...countriesList];
            renderCountryDropdown();
        }

        function renderCountryDropdown() {
            const countryList = document.getElementById('countryList');
            countryList.innerHTML = '';
            
            const t = translations[currentLang];
            
            if (filteredCountries.length === 0) {
                countryList.innerHTML = `<div class="dropdown-item">${t.noCountriesFound}</div>`;
                countryList.classList.add('show');
                return;
            }

            filteredCountries.forEach(country => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = country;
                item.onclick = () => selectCountry(country);
                countryList.appendChild(item);
            });
        }

        function renderCityDropdown() {
            const cityList = document.getElementById('cityList');
            cityList.innerHTML = '';
            
            const t = translations[currentLang];
            
            if (filteredCities.length === 0) {
                cityList.innerHTML = `<div class="dropdown-item">${t.noCitiesFound}</div>`;
                cityList.classList.add('show');
                return;
            }

            filteredCities.forEach(city => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = city.name;
                item.onclick = () => selectCity(city.name);
                cityList.appendChild(item);
            });
        }

        function selectCountry(country) {
            selectedCountry = country;
            document.getElementById('country').value = country;
            document.getElementById('countryList').classList.remove('show');
            document.getElementById('city').disabled = false;
            const t = translations[currentLang];
            document.getElementById('city').placeholder = t.searchCity;
            document.getElementById('city').value = '';
            citiesList = [];
            filteredCities = [];
            fetchCitiesForCountry(country);
        }

        function selectCity(city) {
            document.getElementById('city').value = city;
            document.getElementById('cityList').classList.remove('show');
        }

        async function fetchCitiesForCountry(country) {
            const cityList = document.getElementById('cityList');
            const t = translations[currentLang];
            cityList.innerHTML = `<div class="loading-cities">${t.loadingCities}</div>`;
            cityList.classList.add('show');

            try {
                const searchUrl = `https://secure.geonames.org/searchJSON?q=${encodeURIComponent(country)}&maxRows=1000&featureClass=P&username=demo`;
                let response = await fetch(searchUrl);
                if (!response.ok) throw new Error('GeoNames failed');
                
                let data = await response.json();
                
                if (data.geonames && data.geonames.length > 0) {
                    citiesList = data.geonames
                        .filter(place => place.countryName === country || place.adminName1)
                        .map(place => ({ name: place.name, country: place.countryName }))
                        .filter((city, index, self) => 
                            index === self.findIndex(c => c.name === city.name)
                        )
                        .sort((a, b) => a.name.localeCompare(b.name));
                    
                    filteredCities = [...citiesList];
                    renderCityDropdown();
                } else {
                    citiesList = getMajorCitiesForCountry(country);
                    filteredCities = [...citiesList];
                    renderCityDropdown();
                }
            } catch (error) {
                console.error('Error fetching cities:', error);
                citiesList = getMajorCitiesForCountry(country);
                filteredCities = [...citiesList];
                renderCityDropdown();
            }
        }

        function getMajorCitiesForCountry(country) {
            const majorCities = {
                'Iran': ['Tehran', 'Mashhad', 'Isfahan', 'Karaj', 'Shiraz', 'Tabriz', 'Qom', 'Ahvaz', 'Kermanshah', 'Urmia', 'Rasht', 'Zahedan', 'Hamadan', 'Kerman', 'Yazd', 'Ardabil', 'Bandar Abbas', 'Arak', 'Eslamshahr', 'Zanjan'],
                'United States': ['New York', 'Los Angeles', 'Chicago', 'Houston', 'Phoenix', 'Philadelphia', 'San Antonio', 'San Diego', 'Dallas', 'San Jose'],
                'United Kingdom': ['London', 'Birmingham', 'Manchester', 'Glasgow', 'Liverpool', 'Leeds', 'Edinburgh', 'Bristol', 'Cardiff', 'Belfast'],
                'Canada': ['Toronto', 'Montreal', 'Vancouver', 'Calgary', 'Edmonton', 'Ottawa', 'Winnipeg', 'Quebec City', 'Hamilton', 'Kitchener'],
                'Germany': ['Berlin', 'Munich', 'Hamburg', 'Cologne', 'Frankfurt', 'Stuttgart', 'D√ºsseldorf', 'Dortmund', 'Essen', 'Leipzig'],
                'France': ['Paris', 'Marseille', 'Lyon', 'Toulouse', 'Nice', 'Nantes', 'Strasbourg', 'Montpellier', 'Bordeaux', 'Lille'],
                'Italy': ['Rome', 'Milan', 'Naples', 'Turin', 'Palermo', 'Genoa', 'Bologna', 'Florence', 'Bari', 'Catania'],
                'Spain': ['Madrid', 'Barcelona', 'Valencia', 'Seville', 'Zaragoza', 'M√°laga', 'Murcia', 'Palma', 'Las Palmas', 'Bilbao'],
                'Japan': ['Tokyo', 'Yokohama', 'Osaka', 'Nagoya', 'Sapporo', 'Fukuoka', 'Kobe', 'Kawasaki', 'Kyoto', 'Saitama'],
                'China': ['Beijing', 'Shanghai', 'Guangzhou', 'Shenzhen', 'Chengdu', 'Hangzhou', 'Wuhan', 'Xi\'an', 'Nanjing', 'Tianjin'],
                'India': ['Mumbai', 'Delhi', 'Bangalore', 'Hyderabad', 'Ahmedabad', 'Chennai', 'Kolkata', 'Pune', 'Jaipur', 'Surat'],
                'Australia': ['Sydney', 'Melbourne', 'Brisbane', 'Perth', 'Adelaide', 'Gold Coast', 'Newcastle', 'Canberra', 'Sunshine Coast', 'Wollongong'],
                'Brazil': ['S√£o Paulo', 'Rio de Janeiro', 'Bras√≠lia', 'Salvador', 'Fortaleza', 'Belo Horizonte', 'Manaus', 'Curitiba', 'Recife', 'Porto Alegre'],
                'Russia': ['Moscow', 'Saint Petersburg', 'Novosibirsk', 'Yekaterinburg', 'Kazan', 'Nizhny Novgorod', 'Chelyabinsk', 'Samara', 'Omsk', 'Rostov-on-Don'],
                'Turkey': ['Istanbul', 'Ankara', 'Izmir', 'Bursa', 'Antalya', 'Adana', 'Gaziantep', 'Konya', 'Mersin', 'Diyarbakir'],
                'Mexico': ['Mexico City', 'Guadalajara', 'Monterrey', 'Puebla', 'Tijuana', 'Le√≥n', 'Ju√°rez', 'Torre√≥n', 'Quer√©taro', 'San Luis Potos√≠'],
                'Argentina': ['Buenos Aires', 'C√≥rdoba', 'Rosario', 'Mendoza', 'Tucum√°n', 'La Plata', 'Mar del Plata', 'Salta', 'Santa Fe', 'San Juan'],
                'South Korea': ['Seoul', 'Busan', 'Incheon', 'Daegu', 'Daejeon', 'Gwangju', 'Suwon', 'Ulsan', 'Changwon', 'Goyang'],
                'Saudi Arabia': ['Riyadh', 'Jeddah', 'Mecca', 'Medina', 'Dammam', 'Khobar', 'Taif', 'Tabuk', 'Buraydah', 'Khamis Mushait'],
                'Egypt': ['Cairo', 'Alexandria', 'Giza', 'Shubra El Kheima', 'Port Said', 'Suez', 'Luxor', 'Aswan', 'Asyut', 'Ismailia'],
                'Pakistan': ['Karachi', 'Lahore', 'Faisalabad', 'Rawalpindi', 'Multan', 'Gujranwala', 'Hyderabad', 'Peshawar', 'Islamabad', 'Quetta'],
                'Indonesia': ['Jakarta', 'Surabaya', 'Bandung', 'Medan', 'Semarang', 'Palembang', 'Makassar', 'Batam', 'Pekanbaru', 'Bandar Lampung'],
                'Bangladesh': ['Dhaka', 'Chittagong', 'Khulna', 'Rajshahi', 'Sylhet', 'Comilla', 'Rangpur', 'Mymensingh', 'Barisal', 'Jessore'],
                'Philippines': ['Manila', 'Quezon City', 'Caloocan', 'Davao', 'Cebu', 'Zamboanga', 'Antipolo', 'Pasig', 'Cagayan de Oro', 'Valenzuela'],
                'Thailand': ['Bangkok', 'Nonthaburi', 'Pak Kret', 'Hat Yai', 'Nakhon Ratchasima', 'Chiang Mai', 'Udon Thani', 'Pattaya', 'Khon Kaen', 'Nakhon Si Thammarat'],
                'Vietnam': ['Ho Chi Minh City', 'Hanoi', 'Da Nang', 'Haiphong', 'Can Tho', 'Bien Hoa', 'Hue', 'Nha Trang', 'Vung Tau', 'Quy Nhon'],
                'Malaysia': ['Kuala Lumpur', 'George Town', 'Ipoh', 'Shah Alam', 'Petaling Jaya', 'Johor Bahru', 'Melaka', 'Kota Kinabalu', 'Kuching', 'Seremban'],
                'Singapore': ['Singapore'],
                'Iraq': ['Baghdad', 'Basra', 'Mosul', 'Erbil', 'Najaf', 'Karbala', 'Nasiriyah', 'Amara', 'Samarra', 'Ramadi'],
                'Syria': ['Damascus', 'Aleppo', 'Homs', 'Latakia', 'Hama', 'Tartus', 'Deir ez-Zor', 'Raqqa', 'Idlib', 'Daraa'],
                'Lebanon': ['Beirut', 'Tripoli', 'Sidon', 'Tyre', 'Nabatieh', 'Jounieh', 'Zahle', 'Baalbek', 'Byblos', 'Batroun'],
                'Jordan': ['Amman', 'Zarqa', 'Irbid', 'Russeifa', 'Wadi al-Sir', 'Aqaba', 'Madaba', 'Salt', 'Mafraq', 'Karak'],
                'Yemen': ['Sana\'a', 'Aden', 'Taiz', 'Hodeidah', 'Ibb', 'Dhamar', 'Al-Mukalla', 'Zinjibar', 'Sayyan', 'Lahij'],
                'Kuwait': ['Kuwait City', 'Al Ahmadi', 'Hawalli', 'Al Jahra', 'Al Farwaniyah', 'Salmiya', 'Mangaf', 'Mahboula', 'Abu Halifa', 'Fahaheel'],
                'Qatar': ['Doha', 'Al Rayyan', 'Al Wakrah', 'Al Khor', 'Dukhan', 'Mesaieed', 'Lusail', 'Al Shamal', 'Al Daayen', 'Umm Salal'],
                'United Arab Emirates': ['Dubai', 'Abu Dhabi', 'Sharjah', 'Al Ain', 'Ajman', 'Ras Al Khaimah', 'Fujairah', 'Umm Al Quwain', 'Khor Fakkan', 'Kalba']
            };

            if (majorCities[country]) {
                return majorCities[country].map(name => ({ name, country }));
            }
            
            return [];
        }

        async function loadSavedLocation() {
            const saved = localStorage.getItem('sunsetClockLocation');
            if (saved) {
                try {
                    locationData = JSON.parse(saved);
                    document.getElementById('country').value = locationData.country || '';
                    document.getElementById('city').value = locationData.city || '';
                    if (locationData.country) {
                        selectedCountry = locationData.country;
                        document.getElementById('city').disabled = false;
                        const t = translations[currentLang];
                        document.getElementById('city').placeholder = t.searchCity;
                        await fetchCitiesForCountry(locationData.country);
                    }
                    updateLocationInfo();
                    fetchSunsetTime();
                } catch (e) {
                    console.error('Error loading saved location:', e);
                    await setDefaults();
                }
            } else {
                await setDefaults();
            }
        }

        async function setDefaults() {
            document.getElementById('country').value = DEFAULT_COUNTRY;
            selectedCountry = DEFAULT_COUNTRY;
            document.getElementById('city').disabled = false;
            const t = translations[currentLang];
            document.getElementById('city').placeholder = t.searchCity;
            
            try {
                await fetchCitiesForCountry(DEFAULT_COUNTRY);
                document.getElementById('city').value = DEFAULT_CITY;
                locationData = { country: DEFAULT_COUNTRY, city: DEFAULT_CITY };
                updateLocationInfo();
                fetchSunsetTime();
            } catch (error) {
                console.error('Error setting defaults:', error);
                document.getElementById('city').value = DEFAULT_CITY;
                locationData = { country: DEFAULT_COUNTRY, city: DEFAULT_CITY };
                updateLocationInfo();
                fetchSunsetTime();
            }
        }

        function saveLocation() {
            const country = document.getElementById('country').value.trim();
            const city = document.getElementById('city').value.trim();
            const errorDiv = document.getElementById('error');
            const t = translations[currentLang];

            if (!country || !city) {
                errorDiv.textContent = t.pleaseSelectBoth;
                return;
            }

            if (!countriesList.includes(country)) {
                errorDiv.textContent = t.pleaseSelectValidCountry;
                return;
            }

            errorDiv.textContent = '';
            locationData = { country, city };
            localStorage.setItem('sunsetClockLocation', JSON.stringify(locationData));
            updateLocationInfo();
            fetchSunsetTime();
            document.getElementById('locationPanel').classList.remove('show');
        }

        function updateLocationInfo() {
            const locationText = document.getElementById('locationText');
            const t = translations[currentLang];
            if (locationData) {
                locationText.textContent = `${locationData.city}, ${locationData.country}`;
            } else {
                locationText.textContent = t.pleaseEnterLocation;
            }
        }

        async function fetchSunsetTime() {
            const t = translations[currentLang];
            const statusDiv = document.getElementById('status');
            
            if (!locationData) {
                statusDiv.textContent = t.locationNotSet;
                return;
            }

            statusDiv.textContent = t.fetchingSunset;
            statusDiv.classList.add('loading');

            const cached = localStorage.getItem('sunsetTimeCache');
            let useCached = false;
            if (cached) {
                try {
                    const cachedData = JSON.parse(cached);
                    if (cachedData.date === new Date().toDateString() || !navigator.onLine) {
                        sunsetTime = new Date(cachedData.sunsetTime);
                        useCached = true;
                        if (!navigator.onLine || cachedData.date === new Date().toDateString()) {
                            statusDiv.textContent = t.usingCached;
                            statusDiv.classList.remove('loading');
                            startClock();
                        }
                    }
                } catch (e) {
                    console.error('Error parsing cached data:', e);
                }
            }

            if (navigator.onLine) {
                try {
                    const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationData.city)},${encodeURIComponent(locationData.country)}&limit=1`;
                    const geocodeResponse = await fetch(geocodeUrl);
                    if (!geocodeResponse.ok) throw new Error('Geocoding failed');
                    
                    const geocodeData = await geocodeResponse.json();
                    if (!geocodeData || geocodeData.length === 0) {
                        throw new Error('Location not found');
                    }

                    const lat = geocodeData[0].lat;
                    const lon = geocodeData[0].lon;
                    const today = new Date();
                    const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    const sunsetUrl = `https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=${dateStr}&formatted=0`;
                    const sunsetResponse = await fetch(sunsetUrl);
                    
                    if (!sunsetResponse.ok) throw new Error('Sunset API failed');
                    
                    const sunsetData = await sunsetResponse.json();
                    if (sunsetData.status !== 'OK') {
                        throw new Error('Sunset API error');
                    }

                    sunsetTime = new Date(sunsetData.results.sunset);
                    localStorage.setItem('sunsetTimeCache', JSON.stringify({
                        date: today.toDateString(),
                        sunsetTime: sunsetTime.toISOString(),
                        location: `${locationData.city}, ${locationData.country}`
                    }));

                    statusDiv.textContent = t.sunsetUpdated;
                    statusDiv.classList.remove('loading');
                    startClock();
                } catch (error) {
                    console.error('Error fetching sunset time:', error);
                    statusDiv.textContent = t.errorFetching;
                    statusDiv.classList.remove('loading');
                    
                    if (cached && !useCached) {
                        try {
                            const cachedData = JSON.parse(cached);
                            sunsetTime = new Date(cachedData.sunsetTime);
                            statusDiv.textContent = t.usingCachedOutdated;
                            startClock();
                        } catch (e) {
                            statusDiv.textContent = t.unableToLoad;
                        }
                    } else if (!useCached) {
                        statusDiv.textContent = t.unableToLoad;
                    }
                }
            } else {
                statusDiv.textContent = t.offline;
                statusDiv.classList.remove('loading');
                if (sunsetTime) {
                    startClock();
                }
            }
        }

        function startClock() {
            if (clockInterval) {
                clearInterval(clockInterval);
            }

            if (!sunsetTime) {
                document.getElementById('clock').textContent = '--:--:--';
                return;
            }

            function updateClock() {
                const now = new Date();
                const todaySunset = new Date(sunsetTime);
                todaySunset.setHours(todaySunset.getHours(), todaySunset.getMinutes(), todaySunset.getSeconds(), 0);
                const yesterdaySunset = new Date(todaySunset);
                yesterdaySunset.setDate(yesterdaySunset.getDate() - 1);
                
                let referenceSunset = todaySunset;
                if (now < todaySunset) {
                    referenceSunset = yesterdaySunset;
                }
                
                let timeSinceSunset = now - referenceSunset;
                if (timeSinceSunset < 0) {
                    timeSinceSunset = 0;
                }
                
                const totalSeconds = Math.floor(timeSinceSunset / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                const display = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                document.getElementById('clock').textContent = display;
                
                // Update gradient
                updateGradient();
            }

            updateClock();
            clockInterval = setInterval(updateClock, 1000);
        }

        window.addEventListener('online', () => {
            if (locationData) {
                fetchSunsetTime();
            }
        });

        window.addEventListener('offline', () => {
            const t = translations[currentLang];
            document.getElementById('status').textContent = t.offline;
        });
    </script>
</body>
</html>
