<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Welcome to Sunset Clock</title>
<style>
@import url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css');

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Vazir', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
color: #ffffff;
overflow: hidden;
direction: ltr;
}

body.rtl {
direction: rtl;
}

.overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.95);
display: flex;
align-items: center;
justify-content: center;
z-index: 10000;
}

.modal {
background: linear-gradient(135deg, rgba(26, 26, 46, 0.95) 0%, rgba(22, 33, 62, 0.95) 100%);
border-radius: 20px;
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
width: 90%;
max-width: 650px;
height: 600px;
padding: 40px;
position: relative;
overflow: hidden;
border: 1px solid rgba(255, 255, 255, 0.1);
display: flex;
flex-direction: column;
}

.close-btn {
position: absolute;
top: 15px;
right: 15px;
width: 34px;
height: 34px;
min-width: 34px;
min-height: 34px;
max-width: 34px;
max-height: 34px;
background: rgba(255, 255, 255, 0.1);
border: none;
border-radius: 50%;
color: #ffffff;
font-size: 22px;
line-height: 34px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
padding: 0;
transition: all 0.3s ease;
z-index: 100;
}

body.rtl .close-btn {
right: auto;
left: 15px;
}

.close-btn:hover {
background: rgba(255, 255, 255, 0.2);
transform: scale(1.1);
}

.step-indicators {
display: flex;
justify-content: center;
gap: 10px;
margin-bottom: 30px;
flex-shrink: 0;
}

.indicator {
width: 10px;
height: 10px;
border-radius: 50%;
background: rgba(255, 255, 255, 0.3);
transition: all 0.3s ease;
}

.indicator.active {
background: #ffa500;
width: 30px;
border-radius: 5px;
}

.steps-container {
flex: 1;
position: relative;
overflow: hidden;
min-height: 0;
}

.step {
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
display: flex;
flex-direction: column;
opacity: 0;
visibility: hidden;
transition: opacity 0.3s ease;
}

.step.active {
opacity: 1;
visibility: visible;
}

.step-content {
flex: 1;
overflow-y: auto;
padding-right: 10px;
padding-bottom: 20px;
min-height: 0;
}

body.rtl .step-content {
padding-right: 0;
padding-left: 10px;
}

.step-content::-webkit-scrollbar {
width: 6px;
}

.step-content::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 3px;
}

.step-content::-webkit-scrollbar-thumb {
background: rgba(255, 165, 0, 0.5);
border-radius: 3px;
}

h2 {
font-size: 28px;
margin-bottom: 20px;
color: #ffa500;
text-align: center;
}

p {
font-size: 16px;
line-height: 1.8;
margin-bottom: 15px;
color: rgba(255, 255, 255, 0.9);
}

.emoji {
font-size: 48px;
text-align: center;
margin: 20px 0;
}

.location-setup {
margin-top: 20px;
}

.form-group {
margin-bottom: 20px;
}

label {
display: block;
margin-bottom: 8px;
font-size: 14px;
color: rgba(255, 255, 255, 0.8);
}

select {
width: 100%;
padding: 12px;
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.2);
border-radius: 8px;
color: #ffffff;
font-size: 16px;
font-family: 'Vazir', sans-serif;
cursor: pointer;
transition: all 0.3s ease;
}

select:focus {
outline: none;
border-color: #ffa500;
background: rgba(255, 255, 255, 0.15);
}

select option {
background: #1a1a2e;
color: #ffffff;
}

.buttons {
display: flex;
justify-content: space-between;
gap: 15px;
padding-top: 20px;
border-top: 1px solid rgba(255, 255, 255, 0.1);
flex-shrink: 0;
}

button {
flex: 1;
padding: 14px 24px;
font-size: 16px;
font-family: 'Vazir', sans-serif;
border: none;
border-radius: 10px;
cursor: pointer;
transition: all 0.3s ease;
font-weight: 500;
}

.btn-back,
.btn-skip {
background: rgba(255, 255, 255, 0.1);
color: #ffffff;
}

.btn-back:hover,
.btn-skip:hover {
background: rgba(255, 255, 255, 0.2);
}

.btn-next,
.btn-finish {
background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%);
color: #ffffff;
}

.btn-next:hover,
.btn-finish:hover {
transform: translateY(-2px);
box-shadow: 0 5px 20px rgba(255, 165, 0, 0.4);
}

.btn-next:disabled,
.btn-finish:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}

@media (max-width: 600px) {
.modal {
width: 95%;
height: 90vh;
padding: 30px 20px;
}

h2 {
font-size: 24px;
}

p {
font-size: 14px;
}
}
</style>

<!-- Load translation content files -->
<script src="../content/ui/interface.js"></script>
<script src="../content/ui/prayer.js"></script>
<script src="../content/ui/countries.js"></script>
<script src="../content/ui/cities.js"></script>
<script src="../content/onboarding/en.js"></script>
<script src="../content/onboarding/fa.js"></script>
</head>
<body>
<div class="overlay">
<div class="modal">
<button class="close-btn" onclick="skipOnboarding()">√ó</button>

<div class="step-indicators">
<div class="indicator active" data-step="1"></div>
<div class="indicator" data-step="2"></div>
<div class="indicator" data-step="3"></div>
<div class="indicator" data-step="4"></div>
</div>

<div class="steps-container">
<!-- Step 1: Welcome -->
<div class="step active" data-step="1">
<div class="step-content">
<div class="emoji">üåÖ</div>
<h2 data-i18n="welcome">Welcome to Sunset Clock</h2>
<p data-i18n="welcomeText">A revolutionary way to experience time, aligned with nature's rhythm.</p>
<p data-i18n="welcomeText2">This clock resets at sunset every day, creating a natural 24-hour cycle that connects you to the sun's journey.</p>
</div>
</div>

<!-- Step 2: The Problem -->
<div class="step" data-step="2">
<div class="step-content">
<div class="emoji">üåô</div>
<h2 data-i18n="problemTitle">The Midnight Problem</h2>
<p data-i18n="problemText1">The current system starts the day at midnight - an arbitrary point that splits the night in two.</p>
<p data-i18n="problemText2">This creates confusion: Is 2 AM part of yesterday or today? When does rest time truly begin?</p>
<p data-i18n="problemText3">Our bodies know better - the day ends when the sun sets.</p>
</div>
</div>

<!-- Step 3: The Solution -->
<div class="step" data-step="3">
<div class="step-content">
<div class="emoji">‚òÄÔ∏è</div>
<h2 data-i18n="solutionTitle">The Natural Solution</h2>
<p data-i18n="solutionText1"><strong>Sunset Clock (Ghorub-Cook)</strong> resets at sunset, creating clear boundaries:</p>
<p data-i18n="solutionText2">‚Ä¢ <strong>Night begins at sunset (12:00)</strong> - time for rest, reflection, and worship</p>
<p data-i18n="solutionText3">‚Ä¢ <strong>Day begins at sunrise</strong> - time for activity and work</p>
<p data-i18n="solutionText4">This helps you easily calculate remaining work time and ensure adequate rest.</p>
</div>
</div>

<!-- Step 4: Location Setup -->
<div class="step" data-step="4">
<div class="step-content">
<div class="emoji">üìç</div>
<h2 data-i18n="locationTitle">Set Your Location</h2>
<p data-i18n="locationText">Choose your location to get accurate sunset times:</p>

<div class="location-setup">
<div class="form-group">
<label for="country" data-i18n="countryLabel">Country:</label>
<select id="country">
<option value="" data-i18n="selectCountry">Select a country...</option>
</select>
</div>

<div class="form-group">
<label for="city" data-i18n="cityLabel">City:</label>
<select id="city" disabled>
<option value="" data-i18n="selectCity">Select a city...</option>
</select>
</div>
</div>
</div>
</div>
</div>

<div class="buttons">
<button class="btn-skip" id="leftBtn" onclick="skipOnboarding()" data-i18n="skip">Skip</button>
<button class="btn-next" id="rightBtn" onclick="nextStep()" data-i18n="next">Next</button>
</div>
</div>
</div>

<script>
let currentStep = 1;
let currentLang = 'en';
let countriesData = [];
let citiesData = {};
let selectedCountry = '';
let selectedCity = '';

// Onboarding translations are loaded from external files in HTML head
let translations = {
    en: window.onboardingContent ? window.onboardingContent.en : {},
    fa: window.onboardingContent ? window.onboardingContent.fa : {}
};

function initOnboarding() {
console.log('Onboarding initialized');

window.addEventListener('message', handleParentMessage);
window.parent.postMessage({ type: 'onboardingReady' }, '*');

setupEventListeners();
updateButtons();
}

function setupEventListeners() {
const countrySelect = document.getElementById('country');
const citySelect = document.getElementById('city');

countrySelect.addEventListener('change', loadCities);

citySelect.addEventListener('change', function() {
selectedCity = this.value;
updateButtons();
});
}

function handleParentMessage(event) {
const data = event.data;
console.log('Onboarding received:', data.type);

if (data.type === 'init') {
currentLang = data.lang || 'en';
updateLanguage();
} else if (data.type === 'locationData') {
countriesData = data.countries || [];
console.log('Received', countriesData.length, 'countries');
populateCountries();
}
}

function updateLanguage() {
document.body.className = currentLang === 'fa' ? 'rtl' : '';
const elements = document.querySelectorAll('[data-i18n]');
elements.forEach(el => {
const key = el.getAttribute('data-i18n');
if (translations[currentLang] && translations[currentLang][key]) {
if (el.tagName === 'OPTION') {
el.textContent = translations[currentLang][key];
} else {
el.textContent = translations[currentLang][key];
}
}
});
}

function populateCountries() {
const countrySelect = document.getElementById('country');
const placeholder = countrySelect.querySelector('option[value=""]');
countrySelect.innerHTML = '';

if (placeholder) {
countrySelect.appendChild(placeholder);
}

// Use countries from the modular UI texts
const countries = window.uiTexts && window.uiTexts.countries && window.uiTexts.countries[currentLang] ?
    window.uiTexts.countries[currentLang].countries : {};

const sorted = Object.keys(countries).sort((a, b) => {
return countries[a].localeCompare(countries[b], currentLang === 'fa' ? 'fa' : 'en');
});

sorted.forEach(countryKey => {
const option = document.createElement('option');
option.value = countryKey;
option.textContent = countries[countryKey];
countrySelect.appendChild(option);
});

console.log('Populated', sorted.length, 'countries');
}

async function loadCities() {
const countrySelect = document.getElementById('country');
const citySelect = document.getElementById('city');

selectedCountry = countrySelect.value;
selectedCity = '';

if (!selectedCountry) {
citySelect.disabled = true;
citySelect.innerHTML = `<option value="">${translations[currentLang].selectCity}</option>`;
updateButtons();
return;
}

citySelect.disabled = true;
citySelect.innerHTML = `<option value="">${translations[currentLang].loadingCities}</option>`;
updateButtons();

try {
const response = await fetch(
`https://secure.geonames.org/searchJSON?country=${getCountryCode(selectedCountry)}&featureClass=P&maxRows=100&username=sunclock&orderby=population`
);
const data = await response.json();

if (data.geonames && data.geonames.length > 0) {
citySelect.innerHTML = `<option value="">${translations[currentLang].selectCity}</option>`;

const cities = data.geonames
.sort((a, b) => b.population - a.population)
.slice(0, 50);

cities.forEach(city => {
const option = document.createElement('option');
option.value = city.name;
option.textContent = city.name;
citySelect.appendChild(option);
});

citySelect.disabled = false;
console.log('Loaded', cities.length, 'cities');
} else {
citySelect.innerHTML = `<option value="">No cities found</option>`;
}
} catch (error) {
console.error('Error loading cities:', error);
citySelect.innerHTML = `<option value="">Error loading cities</option>`;
}
}

function getCountryCode(countryName) {
const codes = {
'Iran': 'IR', 'United States': 'US', 'Germany': 'DE', 'France': 'FR',
'United Kingdom': 'GB', 'Canada': 'CA', 'Australia': 'AU', 'Italy': 'IT',
'Spain': 'ES', 'Netherlands': 'NL', 'Afghanistan': 'AF', 'Albania': 'AL',
'Algeria': 'DZ', 'Argentina': 'AR', 'Austria': 'AT', 'Bangladesh': 'BD',
'Belgium': 'BE', 'Brazil': 'BR', 'Bulgaria': 'BG', 'Chile': 'CL',
'China': 'CN', 'Colombia': 'CO', 'Croatia': 'HR', 'Czech Republic': 'CZ',
'Denmark': 'DK', 'Egypt': 'EG', 'Finland': 'FI', 'Greece': 'GR',
'Hungary': 'HU', 'India': 'IN', 'Indonesia': 'ID', 'Iraq': 'IQ',
'Ireland': 'IE', 'Japan': 'JP', 'Jordan': 'JO', 'Kenya': 'KE',
'Kuwait': 'KW', 'Lebanon': 'LB', 'Malaysia': 'MY', 'Mexico': 'MX',
'Morocco': 'MA', 'New Zealand': 'NZ', 'Nigeria': 'NG', 'Norway': 'NO',
'Pakistan': 'PK', 'Peru': 'PE', 'Philippines': 'PH', 'Poland': 'PL',
'Portugal': 'PT', 'Qatar': 'QA', 'Romania': 'RO', 'Russia': 'RU',
'Saudi Arabia': 'SA', 'Singapore': 'SG', 'South Africa': 'ZA',
'South Korea': 'KR', 'Sweden': 'SE', 'Switzerland': 'CH', 'Syria': 'SY',
'Thailand': 'TH', 'Turkey': 'TR', 'Ukraine': 'UA',
'United Arab Emirates': 'AE', 'Venezuela': 'VE', 'Vietnam': 'VN', 'Yemen': 'YE'
};
return codes[countryName] || '';
}

function previousStep() {
if (currentStep <= 1) return;

const currentStepEl = document.querySelector(`.step[data-step="${currentStep}"]`);
const currentIndicator = document.querySelector(`.indicator[data-step="${currentStep}"]`);

currentStepEl.classList.remove('active');
currentIndicator.classList.remove('active');

currentStep--;

const prevStepEl = document.querySelector(`.step[data-step="${currentStep}"]`);
const prevIndicator = document.querySelector(`.indicator[data-step="${currentStep}"]`);

prevStepEl.classList.add('active');
prevIndicator.classList.add('active');

updateButtons();
}

function nextStep() {
if (currentStep >= 4) return;

const currentStepEl = document.querySelector(`.step[data-step="${currentStep}"]`);
const currentIndicator = document.querySelector(`.indicator[data-step="${currentStep}"]`);

currentStepEl.classList.remove('active');
currentIndicator.classList.remove('active');

currentStep++;

const nextStepEl = document.querySelector(`.step[data-step="${currentStep}"]`);
const nextIndicator = document.querySelector(`.indicator[data-step="${currentStep}"]`);

nextStepEl.classList.add('active');
nextIndicator.classList.add('active');

updateButtons();
}

function updateButtons() {
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');

// Left button: Skip on step 1, Back on other steps
if (currentStep === 1) {
leftBtn.className = 'btn-skip';
leftBtn.onclick = skipOnboarding;
leftBtn.setAttribute('data-i18n', 'skip');
leftBtn.textContent = translations[currentLang].skip;
} else {
leftBtn.className = 'btn-back';
leftBtn.onclick = previousStep;
leftBtn.setAttribute('data-i18n', 'back');
leftBtn.textContent = translations[currentLang].back;
}

// Right button: Next on steps 1-3, Start Using on step 4
if (currentStep === 4) {
rightBtn.className = 'btn-finish';
rightBtn.onclick = finishOnboarding;
rightBtn.setAttribute('data-i18n', 'finish');
rightBtn.textContent = translations[currentLang].finish;
rightBtn.disabled = !selectedCity;
} else {
rightBtn.className = 'btn-next';
rightBtn.onclick = nextStep;
rightBtn.setAttribute('data-i18n', 'next');
rightBtn.textContent = translations[currentLang].next;
rightBtn.disabled = false;
}
}

function skipOnboarding() {
window.parent.postMessage({ type: 'skipOnboarding' }, '*');
}

function finishOnboarding() {
if (!selectedCountry || !selectedCity) {
return;
}

console.log('Finishing onboarding with:', selectedCountry, selectedCity);

window.parent.postMessage({
type: 'onboardingComplete',
locationData: {
country: selectedCountry,
city: selectedCity
}
}, '*');
}

document.addEventListener('keydown', (e) => {
if (e.key === 'Escape') {
skipOnboarding();
} else if (e.key === 'Enter') {
if (currentStep < 4) {
nextStep();
} else if (selectedCountry && selectedCity) {
finishOnboarding();
}
}
});

initOnboarding();
</script>
</body>
</html>